# 直接下载功能说明

## 功能概述

本功能实现了通过 `https://源地址/分类/软件id` 格式直接下载软件的能力，无需使用传统的下载链接。

## 主要特性

- ✅ **直接下载路径**: 支持 `https://源地址/分类/软件id` 格式
- ✅ **回退机制**: 直接下载失败时自动回退到传统下载链接
- ✅ **向后兼容**: 完全兼容现有的 `downloadUrl` 字段
- ✅ **错误处理**: 完善的错误处理和用户提示
- ✅ **渐进增强**: 逐步迁移，不影响现有功能

## 文件修改说明

### 1. API文档更新 (`API文档.md`)
- 新增直接下载接口规范
- 添加 `directDownloadPath` 字段说明
- 提供实现示例和错误处理说明

### 2. 客户端代码更新

#### `downloadService.js` (新文件)
- `createDownloadWithFallback()`: 带回退机制的下载函数
- `buildDirectDownloadUrl()`: 构建直接下载URL
- `validateDownloadUrl()`: 验证URL可访问性
- `handleDownloadFailure()`: 处理下载失败和回退

#### `PlatformDownloadSelector.jsx`
- 修改 `handleDownload` 函数，优先使用 `directDownloadPath`
- 保留 `downloadUrl` 作为回退选项

#### `App.jsx`
- 集成 `downloadService`
- 修改 `handleDownload` 函数使用新的下载服务
- 支持进度回调和状态更新

### 3. 数据格式更新

#### `app-source.json`
- 为示例应用添加 `directDownloadPath` 字段
- 格式: `"/分类/软件ID"`

## 使用方法

### 客户端使用

1. **数据格式**:
```json
{
  "id": "1750946046173",
  "name": "微信",
  "downloadUrl": "https://dldir1v6.qq.com/weixin/Universal/Windows/WeChatWin.exe",
  "directDownloadPath": "/software/1750946046173",
  "category": "software"
}
```

2. **下载逻辑**:
- 优先尝试: `https://源地址 + directDownloadPath`
- 失败回退: 使用 `downloadUrl`

### 服务端实现

1. **启动示例服务器**:
```bash
node server-example.js
```

2. **直接下载URL格式**:
```
http://localhost:3000/software/1750946046173
```

3. **API接口**:
```
GET /api/apps - 获取软件列表
GET /api/apps/:id - 获取单个软件信息
GET /:category/:softwareId - 直接下载
```

## 实现细节

### 下载流程

1. **检查直接下载路径**:
   - 如果应用有 `directDownloadPath`，构建完整URL
   - 验证URL可访问性

2. **创建下载任务**:
   - 使用直接下载URL创建任务
   - 设置进度和状态回调

3. **错误处理**:
   - 直接下载失败时，自动尝试 `downloadUrl`
   - 提供用户友好的错误提示

### 服务端路由

```javascript
// 直接下载路由
app.get('/:category/:softwareId', async (req, res) => {
  const { category, softwareId } = req.params;
  
  // 验证软件存在性和分类匹配
  const software = softwareData[softwareId];
  if (!software || software.category !== category) {
    return res.status(404).json({ error: 'Software not found' });
  }
  
  // 重定向到实际下载链接
  res.redirect(302, software.downloadUrl);
});
```

## 兼容性说明

- **完全向后兼容**: 现有的 `downloadUrl` 字段继续工作
- **渐进增强**: 可以逐步为应用添加 `directDownloadPath`
- **优雅降级**: 直接下载失败时自动回退到传统方式

## 测试方法

1. **启动服务器**:
```bash
node server-example.js
```

2. **测试直接下载**:
```bash
curl -I http://localhost:3000/software/1750946046173
```

3. **测试API接口**:
```bash
curl http://localhost:3000/api/apps
```

## 部署建议

1. **生产环境**:
   - 使用HTTPS协议
   - 配置适当的缓存策略
   - 实现访问日志和监控

2. **CDN配置**:
   - 为直接下载路径配置CDN
   - 设置适当的缓存时间

3. **安全考虑**:
   - 验证软件ID格式
   - 防止路径遍历攻击
   - 实现访问频率限制

## 故障排除

1. **直接下载失败**:
   - 检查服务器路由配置
   - 验证软件ID和分类匹配
   - 查看服务器日志

2. **回退机制不工作**:
   - 确认 `downloadUrl` 字段存在
   - 检查网络连接
   - 验证URL格式正确性

## 未来扩展

- 支持多版本下载
- 实现下载统计
- 添加下载权限控制
- 支持断点续传
- 集成文件完整性验证